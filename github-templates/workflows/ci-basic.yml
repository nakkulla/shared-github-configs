name: ğŸ”„ Basic CI Pipeline

# ê¸°ë³¸ì ì¸ CI íŒŒì´í”„ë¼ì¸ ì›Œí¬í”Œë¡œìš°
# Node.js, Python, ì¼ë°˜ì ì¸ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš© ê°€ëŠ¥

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  lint-and-format:
    runs-on: ubuntu-latest
    name: ğŸ“ Code Quality Check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run pre-commit hooks
        uses: pre-commit/action@v3.0.0
        with:
          extra_args: --all-files
        continue-on-error: true

      - name: ğŸ“Š Upload lint results
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: false
        continue-on-error: true

  # ë³´ì•ˆ ê²€ì‚¬
  security-scan:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Scan
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ›¡ï¸ Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ì˜ì¡´ì„± ê²€ì‚¬
  dependency-check:
    runs-on: ubuntu-latest
    name: ğŸ“¦ Dependency Check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check for vulnerable dependencies
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true

  # í†µí•© ìƒíƒœ ë³´ê³ 
  status-check:
    runs-on: ubuntu-latest
    name: âœ… Status Summary
    needs: [lint-and-format, security-scan, dependency-check]
    if: always()
    steps:
      - name: ğŸ“Š Check all job status
        run: |
          echo "=== CI Pipeline Results ==="
          echo "Lint and Format: ${{ needs.lint-and-format.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Dependency Check: ${{ needs.dependency-check.result }}"
          
          if [[ "${{ needs.lint-and-format.result }}" == "failure" ||
                "${{ needs.security-scan.result }}" == "failure" ||  
                "${{ needs.dependency-check.result }}" == "failure" ]]; then
            echo "âŒ Some checks failed - please review the results"
            exit 1
          else
            echo "âœ… All checks passed successfully!"
          fi

      - name: ğŸ‰ Success notification
        if: success()
        run: |
          echo "ğŸ‰ CI Pipeline completed successfully!"
          echo "Ready for merge! ğŸš€"

# ì›Œí¬í”Œë¡œìš° ì„¤ì • ì°¸ê³ ì‚¬í•­:
# 1. secrets.SNYK_TOKEN: Snyk API í† í° (ë³´ì•ˆ ê²€ì‚¬ìš©)
# 2. pre-commit ì„¤ì •ì´ ìˆëŠ” ê²½ìš° .pre-commit-config.yaml íŒŒì¼ í•„ìš”
# 3. í”„ë¡œì íŠ¸ë³„ë¡œ í•„ìš”ì— ë”°ë¼ ë‹¨ê³„ ì¶”ê°€/ì œê±° ê°€ëŠ¥
