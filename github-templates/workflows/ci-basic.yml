name: ğŸ”„ Basic CI Pipeline

# ê¸°ë³¸ì ì¸ CI íŒŒì´í”„ë¼ì¸ ì›Œí¬í”Œë¡œìš°
# Node.js, Python, Go, ì¼ë°˜ì ì¸ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš© ê°€ëŠ¥
# 2025ë…„ ìµœì‹  GitHub Actions ë²„ì „ ì‚¬ìš©

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  lint-and-format:
    runs-on: ubuntu-latest
    name: ğŸ“ Code Quality Check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Node.js í”„ë¡œì íŠ¸ ê°ì§€ ë° ì„¤ì •
      - name: ğŸŸ¢ Setup Node.js
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Python í”„ë¡œì íŠ¸ ê°ì§€ ë° ì„¤ì •
      - name: ğŸ Setup Python
        if: hashFiles('requirements.txt', 'pyproject.toml', 'setup.py') != ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Go í”„ë¡œì íŠ¸ ê°ì§€ ë° ì„¤ì •
      - name: ğŸ”· Setup Go
        if: hashFiles('go.mod') != ''
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: ğŸ” Run pre-commit hooks
        uses: pre-commit/action@v3.0.1
        with:
          extra_args: --all-files
        continue-on-error: true

      - name: ğŸ“Š Super Linter
        uses: github/super-linter@v5
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_JSCPD: false  # ì¤‘ë³µ ì½”ë“œ ê²€ì‚¬ ë¹„í™œì„±í™” (ë„ˆë¬´ ì—„ê²©í•¨)
        continue-on-error: true

  # ë³´ì•ˆ ê²€ì‚¬
  security-scan:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Scan
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ›¡ï¸ Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'  # ì¤‘ìš”ë„ ë†’ì€ ê²ƒë§Œ ê²€ì‚¬
        continue-on-error: true

      - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ë¹Œë“œ í…ŒìŠ¤íŠ¸ (í”„ë¡œì íŠ¸ ìœ í˜•ë³„)
  build-test:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Build & Test
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Node.js ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
      - name: ï¿½ Node.js Build & Test
        if: hashFiles('package.json') != ''
        run: |
          if [ -f "package.json" ]; then
            npm ci
            npm run build --if-present
            npm test --if-present
          fi

      # Python ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
      - name: ğŸ Python Build & Test
        if: hashFiles('requirements.txt', 'pyproject.toml', 'setup.py') != ''
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          elif [ -f "pyproject.toml" ]; then
            pip install -e .
          fi
          python -m pytest --if-present || echo "No tests found"

      # Go ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
      - name: ğŸ”· Go Build & Test
        if: hashFiles('go.mod') != ''
        run: |
          go build ./...
          go test ./... || echo "No tests found"

  # ì˜ì¡´ì„± ê²€ì‚¬ (ê°„ì†Œí™”)
  dependency-check:
    runs-on: ubuntu-latest
    name: ğŸ“¦ Dependency Check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Node.js ë³´ì•ˆ ê°ì‚¬
      - name: ğŸŸ¢ Node.js Security Audit
        if: hashFiles('package.json') != ''
        run: |
          npm audit --audit-level high || echo "npm audit completed with warnings"
        continue-on-error: true

      # Python ë³´ì•ˆ ê²€ì‚¬ (pip-audit)
      - name: ğŸ Python Security Audit
        if: hashFiles('requirements.txt', 'pyproject.toml') != ''
        run: |
          pip install pip-audit
          pip-audit || echo "pip-audit completed with warnings"
        continue-on-error: true

  # í†µí•© ìƒíƒœ ë³´ê³ 
  status-check:
    runs-on: ubuntu-latest
    name: âœ… Status Summary
    needs: [lint-and-format, security-scan, build-test, dependency-check]
    if: always()
    steps:
      - name: ğŸ“Š Check all job status
        run: |
          echo "=== CI Pipeline Results ==="
          echo "Lint and Format: ${{ needs.lint-and-format.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Build & Test: ${{ needs.build-test.result }}"
          echo "Dependency Check: ${{ needs.dependency-check.result }}"
          
          # í•„ìˆ˜ ì²´í¬ë§Œ ì‹¤íŒ¨ ì‹œ ì¢…ë£Œ (ë³´ì•ˆ, ë¹Œë“œëŠ” ì„ íƒ)
          if [[ "${{ needs.lint-and-format.result }}" == "failure" ||
                "${{ needs.build-test.result }}" == "failure" ]]; then
            echo "âŒ Critical checks failed - please fix before merge"
            exit 1
          else
            echo "âœ… Critical checks passed!"
            if [[ "${{ needs.security-scan.result }}" == "failure" ||  
                  "${{ needs.dependency-check.result }}" == "failure" ]]; then
              echo "âš ï¸  Some optional checks failed - please review"
            fi
          fi

      - name: ğŸ‰ Success notification
        if: success()
        run: |
          echo "ğŸ‰ CI Pipeline completed successfully!"
          echo "Ready for merge! ğŸš€"

# ì›Œí¬í”Œë¡œìš° ì„¤ì • ì°¸ê³ ì‚¬í•­:
# 1. í”„ë¡œì íŠ¸ ìœ í˜• ìë™ ê°ì§€ (package.json, requirements.txt, go.mod ë“±)
# 2. ìµœì‹  GitHub Actions ë²„ì „ ì‚¬ìš© (v4, v5)
# 3. ì„ íƒì  ì˜ì¡´ì„± - Snyk í† í° ë¶ˆí•„ìš” (ë‚´ì¥ ë„êµ¬ ì‚¬ìš©)
# 4. ë¹Œë“œ/í…ŒìŠ¤íŠ¸ ë‹¨ê³„ ì¶”ê°€ë¡œ ì‹¤ì œ ë™ì‘ í™•ì¸
# 5. continue-on-errorë¡œ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ë‹¨ê³„ ê³„ì† ì§„í–‰
# 6. workflow_dispatchë¡œ ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
