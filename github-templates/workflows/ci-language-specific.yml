name: ğŸš€ Language-Specific CI

# í”„ë¡œì íŠ¸ ì–¸ì–´ë³„ íŠ¹í™” CI ì›Œí¬í”Œë¡œìš°
# ê° ì–¸ì–´ë³„ ìµœì í™”ëœ ë¹Œë“œ/í…ŒìŠ¤íŠ¸ íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:

jobs:
  # í”„ë¡œì íŠ¸ ìœ í˜• ê°ì§€
  detect-project-type:
    runs-on: ubuntu-latest
    outputs:
      is-node: ${{ steps.detect.outputs.is-node }}
      is-python: ${{ steps.detect.outputs.is-python }}
      is-go: ${{ steps.detect.outputs.is-go }}
      is-rust: ${{ steps.detect.outputs.is-rust }}
      is-java: ${{ steps.detect.outputs.is-java }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Detect project type
        id: detect
        run: |
          echo "is-node=$([ -f 'package.json' ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "is-python=$([ -f 'requirements.txt' -o -f 'pyproject.toml' -o -f 'setup.py' ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "is-go=$([ -f 'go.mod' ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "is-rust=$([ -f 'Cargo.toml' ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "is-java=$([ -f 'pom.xml' -o -f 'build.gradle' -o -f 'build.gradle.kts' ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  # Node.js í”„ë¡œì íŠ¸ CI
  nodejs-ci:
    needs: detect-project-type
    if: needs.detect-project-type.outputs.is-node == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]
    name: ğŸŸ¢ Node.js ${{ matrix.node-version }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Lint
        run: npm run lint --if-present

      - name: ğŸ—ï¸ Build
        run: npm run build --if-present

      - name: ğŸ§ª Test
        run: npm test --if-present

      - name: ğŸ“Š Coverage
        run: npm run coverage --if-present

  # Python í”„ë¡œì íŠ¸ CI
  python-ci:
    needs: detect-project-type
    if: needs.detect-project-type.outputs.is-python == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    name: ğŸ Python ${{ matrix.python-version }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f pyproject.toml ]; then pip install -e .; fi

      - name: ğŸ” Lint with flake8
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: ğŸ§ª Test with pytest
        run: |
          pip install pytest pytest-cov
          pytest --cov=. --cov-report=xml || echo "No tests found"

  # Go í”„ë¡œì íŠ¸ CI
  go-ci:
    needs: detect-project-type
    if: needs.detect-project-type.outputs.is-go == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.20', '1.21', '1.22']
    name: ğŸ”· Go ${{ matrix.go-version }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”· Setup Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: ğŸ“¦ Download dependencies
        run: go mod download

      - name: ğŸ” Lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest

      - name: ğŸ—ï¸ Build
        run: go build -v ./...

      - name: ğŸ§ª Test
        run: go test -v -race -coverprofile=coverage.out ./...

  # Rust í”„ë¡œì íŠ¸ CI
  rust-ci:
    needs: detect-project-type
    if: needs.detect-project-type.outputs.is-rust == 'true'
    runs-on: ubuntu-latest
    name: ğŸ¦€ Rust
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: ğŸ“¦ Cache cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: ğŸ” Format check
        run: cargo fmt --all -- --check

      - name: ğŸ” Clippy
        run: cargo clippy -- -D warnings

      - name: ğŸ—ï¸ Build
        run: cargo build --verbose

      - name: ğŸ§ª Test
        run: cargo test --verbose

  # Java í”„ë¡œì íŠ¸ CI
  java-ci:
    needs: detect-project-type
    if: needs.detect-project-type.outputs.is-java == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [11, 17, 21]
    name: â˜• Java ${{ matrix.java-version }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'

      # Maven í”„ë¡œì íŠ¸
      - name: ğŸ”§ Maven build and test
        if: hashFiles('pom.xml') != ''
        run: |
          ./mvnw clean compile test

      # Gradle í”„ë¡œì íŠ¸
      - name: ğŸ”§ Gradle build and test
        if: hashFiles('build.gradle', 'build.gradle.kts') != ''
        run: |
          ./gradlew build test
